1. Initializing the Workspace

```bash
mkdir uvws && cd uvws
uv init --package  # Initialize the root project

# Test the root project
uv run uvws uvws  # Expected output: Hello from uvws!

# Initialize the core package
uv init packages/core --package --name uvws-core
# run the core script (see pyproject.toml project.scripts])
uv run --package uvws-core uvws-core  # Expected output: Hello from uvws-core!
# can run via python (this works because uv creates pth file per package)
source ./.venv/bin/activate
python -c "from uvws_core import main; main()"
```

2. Adding Functionality to `core`
```bash
echo -e '\n__version__ = "0.0.0"\n\ndef hi() -> str:\n    return "hi from core"' >> ./packages/core/src/uvws_core/__init__.py

# Run the method
uv run --package uvws-core python -c "import uvws_core; print(uvws_core.hi())"
```

3. Creating and Linking svc1

```bash
uv init packages/svc1 --package --name uvws-svc1
uv run --package uvws-svc1 uvws-svc1  # Expected output: Hello from uvws-svc1!

# Make core a dependency of svc1
uv add --package uvws-svc1 ./packages/core

# Verify dependencies
cat ./packages/svc1/pyproject.toml
```

4. Using core in svc1
```bash
echo -e 'from uvws_core import hi\n\n__version__ = "0.0.0"\n\n\ndef main() -> None:\n    print("svc1 say: ", hi())' > packages/svc1/src/uvws_svc1/__init__.py

# Test the updated svc1 (by running the uvws-svc1 script)
uv run --package uvws_svc1 uvws-svc1  # Expected output: hi from core
```

5. Ensuring Build works
```bash
uv build --all-packages  # Builds uvws, core, and svc1
tar -tzf ./dist/uvws_svc1-0.1.0.tar.gz # inspect tgz package
unzip -l ./dist/uvws_svc1-0.1.0-py3-none-any.whl # inspect whl package
# inspect that svc1 package depends on uvws-core package
unzip -p ./dist/uvws_svc1-0.1.0-py3-none-any.whl 'uvws_svc1-0.1.0.dist-info/METADATA' | grep '^Requires-Dist'
rm -rf ./dist
```

6. Installing Dependencies
```bash
uv add python-semantic-release --dev
```

7. Downloading the Monorepo Parser
```bash
mkdir -p ./scripts/psr/custom_parser
curl https://raw.githubusercontent.com/asaf/uvws/refs/heads/main/scripts/psr/custom_parser/monorepo_parser.py -o ./scripts/psr/custom_parser/monorepo_parser.py
```
8. Configuring PSR for core
```bash
cat <<'EOF' >> ./packages/core/pyproject.toml

[tool.semantic_release]
build_command = "pip install uv && uv build"
commit_parser = "../../scripts/psr/custom_parser/monorepo_parser.py:ConventionalCommitMonorepoParser"
commit_message = """
chore(core-release): Release `core@{version}` [skip ci]
Automatically generated by python-semantic-release
"""
allow_zero_version = true
tag_format = "core-{version}"
version_toml = ["pyproject.toml:project.version"]
version_variables = ["src/uvws_core/__init__.py:__version__"]

[tool.semantic_release.branches.main]
match = "main"
prerelease = false

[tool.semantic_release.branches.beta]
match = "beta"
prerelease = true
prerelease_token = "beta"

[tool.semantic_release.publish]
dist_glob_patterns = ["../../dist/uvws_core-*"]

EOF
```

9. 
```bash
git add .
git commit -m 'feat: create repo and push code'
git remote add origin https://github.com/mdop297/uv-monorepo.git
git branch -M main
git push origin main
```

10.1. Releasing core
```bash
# change "hi from core" -> "hi from core!"
sed -i '' 's/return "hi from core"/return "hi from core!"/' packages/core/src/uvws_core/__init__.py
git add packages/core/src/uvws_core/__init__.py
git commit -m 'fix(core): a minor change in __init__.py'
```


10.2. 
- remember to generate github token then export it into your shell, view [this file](./generate_token.md):
- to trigger release, please follow Conventional Commit Structure: `<type>[<pkg>-optional scope]: <description>`
```bash
cd packages/core
# next version is 0.1.0
semantic-release --noop version --print
# create the release
semantic-release version
```

11. Configuring PSR for svc1
```bash
# NOTE: change dir to project's root folder
cat <<'EOF' >> ./packages/svc1/pyproject.toml
[tool.semantic_release]
build_command = "pip install uv && uv build"
commit_parser = "../../scripts/psr/custom_parser/monorepo_parser.py:ConventionalCommitMonorepoParser"
commit_message = """\
chore(svc1-release): Release `svc1@{version}` [skip ci]
Automatically generated by python-semantic-release
"""

allow_zero_version = true
tag_format = "svc1-{version}"
version_toml = ["pyproject.toml:project.version"]
version_variables = ["src/uvws_svc1/__init__.py:__version__"]

[tool.semantic_release.branches.main]
match = "main"
prerelease = false

[tool.semantic_release.branches.beta]
match = "beta"
prerelease = true
prerelease_token = "beta"

[tool.semantic_release.publish]
dist_glob_patterns = ["../../dist/uvws_svc1-*"]
EOF

git add packages/svc1/pyproject.toml
git commit -m 'chore: configure PSR in svc1'
```

11.2. Releasing svc1
```bash
cd packages/svc1
# next version is 0.1.0
semantic-release --noop version --print
# create the release
semantic-release version
```

12. Configure PSR for Root package (uvws)

```bash
echo -e "\n\n__version__ = \"0.0.0\"" >> ./src/uvws/__init__.py
```
```bash
cat <<'EOF' >> ./pyproject.toml

[tool.semantic_release]
build_command = "pip install uv && uv build"
commit_parser = "./scripts/psr/custom_parser/monorepo_parser.py:ConventionalCommitMonorepoParser"
commit_message = """\
chore(uvws-release): Release `uvws@{version}` [skip ci]
Automatically generated by python-semantic-release
"""
allow_zero_version = true
tag_format = "uvws-{version}"
version_toml = ["pyproject.toml:project.version"]
version_variables = ["src/uvws/__init__.py:__version__"]

[tool.semantic_release.commit_parser_options]
path_filters=[".", "!packages/core/*", "!packages/svc1/*"]

[tool.semantic_release.branches.main]
match = "main"
prerelease = false

[tool.semantic_release.branches.beta]
match = "beta"
prerelease = true
prerelease_token = "beta"

[tool.semantic_release.publish]
dist_glob_patterns = ["./dist/uvws-*"]

EOF

git add pyproject.toml ./src/uvws/__init__.py
git commit -m 'chore: configure PSR for root package'
```

- REMEMBER TO REVIEW `build_command` in `pyproject.toml` file

```bash
# next version is 0.1.0
semantic-release --noop version --print
# create the release
semantic-release version
```

## Coding → Committing → Releasing
- Make changes in `core`:
```bash
# NOTE: change dir to project's root folder
sed -i'' -e 's/\(hi from core\)/\1 - updated!/' ./packages/core/src/uvws_core/__init__.py
git add ./packages/core/src/uvws_core/__init__.py
git commit -m "fix(core): Update hi function"
git push origin main
```
- Release the updated package:
```bash
cd packages/core
semantic-release version
```
- Since we committed a minor (fix) change, this will bump to 0.0.2.
```bash
git tag -l |grep core
# core-0.1.0
# core-0.1.1
# core-0.1.2
```

- check the change log:
```bash
cat ./packages/core/CHANGELOG.md
```

# Release via Github Actions
## The GitHub Action files

```bash
# NOTE: change dir to project's root folder
mkdir -p ./.github/workflows
# a reusable workflow to release any package
curl https://github.com/asaf/uvws/blob/main/.github/workflows/release-package.yml -o ./.github/workflows/release-package.yml
# the actual release workflow, releasing core, svc1 and the uvws root package
curl https://github.com/asaf/uvws/blob/main/.github/workflows/release.yml -o.yml
# a script syncing the repo to latest
curl https://raw.githubusercontent.com/asaf/uvws/refs/heads/main/scripts/update_package_deps.py -o ./scripts/update_package_deps.py
git add .github/*
git commit -m 'build: release automations via github action'
git push origin HEAD:main
```

- Add a secret named PYPI_API_TOKEN to the repo via UI or CLI containing the pypi token.
```bash
echo "my_token" | gh secret set PYPI_API_TOKEN --repo <user>/<repo>
```

- Try to commit and push to main or beta, which will auto trigger a release and push the built artifact to PYPI.